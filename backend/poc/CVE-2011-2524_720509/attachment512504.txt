/* Compile with:

   gcc -o test test.c `pkg-config --cflags --libs libsoup-2.4`

*/

#include <stdio.h>
#include <libsoup/soup.h>

int
main (int argc, char **argv)
{
  struct sockaddr_in sin;
  SoupAddress *addr;
  SoupServer *server;
  guint port;
  SoupSession *session;
  char *uri;
  SoupMessage *msg;

  g_type_init ();

  sin.sin_family = AF_INET;
  sin.sin_addr.s_addr = htonl (INADDR_LOOPBACK);
  sin.sin_port = 0;
  addr = soup_address_new_from_sockaddr ((struct sockaddr *)&sin, sizeof (sin));
  server = soup_server_new ("interface", addr, NULL);
  soup_server_run_async (server);
  addr = soup_socket_get_local_address (soup_server_get_listener (server));
  port = soup_address_get_port (addr);

  session = soup_session_async_new ();
  uri = g_strdup_printf ("http://127.0.0.1:%u/..%%2ftest", port);
  msg = soup_message_new ("GET", uri);
  g_free (uri);

  soup_session_send_message (session, msg);

  if (msg->status_code == SOUP_STATUS_BAD_REQUEST)
    {
      printf ("ok\n");
      return 0;
    }
  else if (msg->status_code == SOUP_STATUS_NOT_FOUND)
    {
      printf ("SECURITY HOLE DETECTED!\n");
      return 1;
    }

  printf ("Something went wrong?!\n");
  return 1;
}
