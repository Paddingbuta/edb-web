{
    "bugid": "223129",
    "cveid": [
        "CVE-2007-0001"
    ],
    "summary": "CVE-2007-0001 kernel panic watching /etc/passwd",
    "alias": "None",
    "product": "Red Hat Enterprise Linux 4",
    "hardware": "All",
    "os": "Linux",
    "url": "",
    "reported_date": "2007-01-17 22:35 UTC bySteve Grubb",
    "attachment": [
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=146837"
    ],
    "comment": [
        "Description of problem:\nJan 17 11:13:11 lxwstest sshd(pam_unix)[3998]: session opened for user\nclarkp by (uid=0)\nJan 17 11:14:43 lxwstest kernel: Unable to handle kernel NULL pointer\ndereference at virtual address 00000004\nJan 17 11:14:43 lxwstest kernel:  printing eip:\nJan 17 11:14:43 lxwstest kernel: c013e454\nJan 17 11:14:43 lxwstest kernel: *pde = 1e164001\nJan 17 11:14:43 lxwstest kernel: Oops: 0000 [#1]\nJan 17 11:14:43 lxwstest kernel: SMP\nJan 17 11:14:43 lxwstest kernel: Modules linked in: parport_pc lp\nparport autofs4 i2c_dev i2c_core sunrpc ipt_REJECT ipt_state\nip_conntrack iptable_filter ip_tables dm_mod button battery ac md5 ipv6\nuhci_hcd snd_intel8x0 snd_ac97_codec snd_pcm_oss snd_mixer_oss snd_pcm\nsnd_timer snd_page_alloc snd_mpu401_uart snd_rawmidi snd_seq_device snd\nsoundcore 3c59x mii floppy ext3 jbd\nJan 17 11:14:43 lxwstest kernel: CPU:    0\nJan 17 11:14:43 lxwstest kernel: EIP:    0060:[<c013e454>]    Not\ntainted VLI\nJan 17 11:14:43 lxwstest kernel: EFLAGS: 00010202   (2.6.9-42.0.3.ELsmp)\nJan 17 11:14:43 lxwstest kernel: EIP is at audit_data_get+0x83/0xdd\nJan 17 11:14:43 lxwstest kernel: eax: 00000000   ebx: d8057de8   ecx:\n00000012   edx: dfe214dc\nJan 17 11:14:43 lxwstest kernel: esi: 00000000   edi: 00000001   ebp:\nd755804c   esp: de291e7c\nJan 17 11:14:43 lxwstest kernel: ds: 007b   es: 007b   ss: 0068\nJan 17 11:14:43 lxwstest kernel: Process useradd (pid: 4036,\nthreadinfo=de291000 task=d74ba230)\nJan 17 11:14:43 lxwstest kernel: Stack: d75580c0 d91bc38c d75580c7\nc013e7d7 d91bc38c dee02b20 00000000 df8e44a4\nJan 17 11:14:43 lxwstest kernel:        d755804c df8e4474 df8e447c\nc017037d e08a09e0 df8e4474 00000000 df7d5de8\nJan 17 11:14:43 lxwstest kernel:        c01694e7 c16debc0 d755804c\nc16debc0 00000000 c16debc0 c16debc0 d755804c\nJan 17 11:14:43 lxwstest kernel: Call Trace:\nJan 17 11:14:43 lxwstest kernel:  [<c013e7d7>]\naudit_update_watch+0xbc/0x1b0\nJan 17 11:14:43 lxwstest kernel:  [<c017037d>] d_move+0x188/0x1ce\nJan 17 11:14:43 lxwstest kernel:  [<c01694e7>]\nvfs_rename_other+0xd8/0x125\nJan 17 11:14:43 lxwstest kernel:  [<c016981f>] vfs_rename+0x2eb/0x338\nJan 17 11:14:43 lxwstest kernel:  [<c01699b9>] sys_rename+0x14d/0x1e0\nJan 17 11:14:43 lxwstest kernel:  [<c010a142>]\ndo_syscall_trace+0xc0/0xca\nJan 17 11:14:43 lxwstest kernel:  [<c02d47cb>] syscall_call+0x7/0xb\nJan 17 11:14:43 lxwstest kernel: Code: 58 08 73 0c 8b 02 8d 50 04 8b 40\n04 85 c0 75 ef 8b 02 85 c0 74 0b 39 58 08 75 06 ff 00 89 c6 eb 54 85 ff\n74 50 8b 35 f8 ad 43 c0 <8b> 46 04 ff 0d f4 ad 43 c0 a3 f8 ad 43 c0 c7\n46 10 00 00 00 00\nJan 17 11:14:43 lxwstest kernel:  <0>Fatal exception: panic in 5 seconds\nJan 17 11:51:12 lxwstest syslogd 1.4.1: restart.\nJan 17 11:51:12 lxwstest syslog: syslogd startup succeeded\nJan 17 11:51:12 lxwstest kernel: klogd 1.4.1, log source = /proc/kmsg\nstarted.\nJan 17 11:51:12 lxwstest kernel: Linux version 2.6.9-42.0.3.ELsmp\n(brewbuilder.redhat.com) (gcc version 3.4.6 20060404\n(Red Hat 3.4.6-3)) #1 SMP Mon Sep 25 17:28:02 EDT 2006\n\n\nVersion-Release number of selected component (if applicable):\n2.6.9-42.0.3.EL\n\nHow reproducible:\n\n\nSteps to Reproduce:\n1. auditctl -w /etc/shadow\n2. useradd userb\n  \nActual results:\nMachine freezes\n\nExpected results:\nuser to be added\n\nAdditional info:\nRH support - ticket #1241786",
        "if (ret) {\n                ret->count++;\n        } else if (allocate) {\n                ret = audit_data_pool;\n                audit_data_pool = ret->next_hash;        <----------- Crash Here\n                audit_pool_size--;\n                dprintk(\"allocate from pool. %d left\\n\", audit_pool_size);",
        "Createdattachment 145943[details]potential fix for problem\n\nThis is an untested proposed patch for this problem.",
        "I don't like that patch -- isn't the whole point of the pool that we're\npreallocating data structures so that we can use them later, in a context where\nwe cannot allocate? If we don't have enough in the pool then there's a real\nunderlying problem which needs to be fixed.",
        "Createdattachment 146837[details]syslog kern.debug output with dprintk on, working on serial access",
        "QE ack for RHEL4.5.",
        "Createdattachment 147495[details]Potential fix\n\nThis message was sent to the upstream audit list.  I am still hoping for some\ncomments....\n\n**********************\n\nSince the upstream filesystem auditing is different than RHEL4 this\nproblem (I believe) is RHEL4 specific.\tLets assume I add the rule\n\nauditctl -w /tmp/watched_file\n\nthen I run\n\ntouch /tmp/unwatched_file\nmv -f /tmp/unwatech_file /tmp/watched_file\n\nFor the purposes of this discussion lets call the inode for the\noriginal /tmp/watched_file i1 and the indoe for the\noriginal /tmp/unwatched_file i2.\n\nThe RHEL4 kernel panics.  The reason is because it wants to allocate a\naudit_inode_data to i2 but there is no audit_inode_data to allocate.\nThus we get the panic as seen in RHBZ 223129.\t\n\nWhen the watch was originally inserted the kernel mallocs 2\naudit_inode_data structs.  One for the inode to be watched and one for\nthe parent of the that inode.  In our case the panic happens because\nthose 2 structs are allocated for i1 and for the inode associated\nwith /tmp.  From looking at the code I saw that in d_move we were\ndropping the audit_inode_data associated with i2 (inside that function\ni2 is pointed at by \"dentry\") at the beginning.  But we were not\ndropping the watch on i1.  It appears that the watch was intended to\nhave been dropped on i1 later in i_put.  At the end of d_move we add the\nwatch for i2.  It was at this point that things blew up (as i_put had\nnot yet released the data structure.)\n\nMy first attempt at fixing this simply was to change d_move such that it\nwould drop the audit_inode_data for both i1 and i2 and then add it back\nto i2 once i2 was the inode which needed the watch.  This however simply\nmoved the panic into i_put when it wanted to remove the audit_inode_data\nfrom the original i1.  The reason it panics there is because when trying\nto fetch the audit_inode_data to free it, it was actually trying to\nallocate a new struct so it had something to free!  My solution simply\npasses a new flag to audit_data_get which states if the intent of\nrequesting the audit_inode_data is to use it or to remove it.  If the\nintent of getting the audit_inode_data was to simply remove that struct\nfrom the inode there is no need to allocate a new one just to have it\nremoved.\n\nThis patch appears to fix the panic and to correctly watch the correct\ninodes at the correct times.  I'd love comment as there may be other\nsolutions to either of the problems.  Maybe we like the removal of the\nwatch on i1 in d_move but we don't like the new flags.\tIn that case we\ncould just 'mess' around with i1 at the end of d_move such that it\nwouldn't watch the watch in i_put and wouldn't ever get into\naudit_data_get to cause the secondary panic.  Maybe there is something\nI'm missing altogether.  Anyway comments please before I put this into a\nRHEL4 kernel would be appreciated.\n\n-Eric",
        "committed in stream U5 build 47. A test kernel with this patch is available fromhttp://people.redhat.com/~jbaron/rhel4/",
        "changed:\n\n           What    |Removed                     |Added\n----------------------------------------------------------------------------\n             Status|ASSIGNED                    |FIXEDAWAITINGTEST\n     Public Release|                            |expected in 42.47 or later\n         Resolution|                            |FIX_BY_IBM\n   Target Milestone|---                         |RHEL4_U5\n\n\n\n\n------- Additional Comments From sglass.com  2007-02-13 10:51 EDT -------\nThis will be in the RHEL 4.5 beta.",
        "committed in stream E5 build 42.0.10.",
        "This issue affects _only_ the Red Hat Enterprise Linux 4 kernel. Other kernel\nversions or upstream kernels are _not_ known be affected.",
        "verified on an x86_64 xen guest and an ia64 system.",
        "An advisory has been issued which should help the problem\ndescribed in this bug report. This report is therefore being\nclosed with a resolution of ERRATA. For more information\non the solution and/or where to find the updated files,\nplease follow the link below. You may reopen this bug report\nif the solution does not work for you.http://rhn.redhat.com/errata/RHSA-2007-0085.html",
        "committed in stream U5 build 49. A test kernel with this patch is available fromhttp://people.redhat.com/~jbaron/rhel4/"
    ]
}