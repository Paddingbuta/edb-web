{
    "bugid": "1283377",
    "cveid": [
        "CVE-2016-3139"
    ],
    "summary": "CVE-2016-3139 Local RedHat Enterprise Linux DoS \u2013 RHEL 7.1 Kernel crashes on invalid  USB device descriptors (wacom driver) [local-DoS] Bug2",
    "alias": "None",
    "product": "Red Hat Enterprise Linux 7",
    "hardware": "Unspecified",
    "os": "Unspecified",
    "url": "",
    "reported_date": "2015-11-18 20:38 UTC byRalf Spenneberg",
    "attachment": [
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=1096290",
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=1096291",
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=1096293"
    ],
    "comment": [
        "Description of problem:\nLocal RedHat Enterprise Linux DoS \u2013 RHEL 7.1 Kernel crashes on invalid \nUSB device descriptors (wacom driver) [local-DoS]Bug2Version-Release number of selected component (if applicable):\nKernel-Version: 3.10.0-229.20.1.el7.x86_64 \n\nHow reproducible:\nalways\n\nOpenSource Security Ralf Spenneberg\nAm Bahnhof 3-5\n48565 Steinfurt\ninfo\n\n\nDate: November 12th, 2015\nAuthors: Sergej Schumilo, Hendrik Schwartke, Ralf Spenneberg\nCVE: not yet assigned\nCVSS: 4.9 (AV:L/AC:L/Au:N/C:N/I:N/A:C) \nTitle: Local RedHat Enterprise Linux DoS \u2013 RHEL 7.1 Kernel crashes on invalid \nUSB device descriptors (wacom driver) [local-DoS]\nSeverity: Critical. The Kernel panics. A reboot is required.\nEase of Exploitation: Trivial\nVulnerability type: Wrong input validation\nProducts: RHEL 7.1 including all updates\nKernel-Version: 3.10.0-229.20.1.el7.x86_64 \n(for debugging-purposes we used the CentOS Kernel kernel-debuginfo-3.10.0-229.14.1.el7)\n\n\nAbstract\nThe Kernel 3.10.0-229.20.1.el7.x86_64 crashes when presented a buggy USB \ndevice which requires the wacom driver.\nDetailed product description\nWe confirmed the bug on the following system:\nRHEL 7.1\nKernel = 3.10.0-229.20.1.el7.x86_64\nFurther products or kernel versions have not been tested.\nHow reproducible: Always\nActual results: Kernel crashes \n\nDescription:\nThe bug was found using the USB-fuzzing framework vUSBf from Sergej Schumilo \n(github.com/schumilo) using the following device descriptor:\n\n ######### PAYLOAD 1 #########\n[*] Device-Descriptor\n  bLength:\t\t0x12\n  bDescriptorType:\t0x1\n  bcdUSB:\t\t0x200\n  bDeviceClass:\t\t0x3\n  bDeviceSubClass:\t0x0\n  bDeviceProtocol:\t0x0\n  bMaxPacketSize:\t0x40\n  idVendor:\t\t0x56a\n  idProduct:\t\t0x90\n  bcdDevice:\t\t0x100\n  iManufacturer:\t0x1\n  iProduct:\t\t0x2\n  iSerialNumbers:\t0x3\n  bNumConfigurations:\t0x1\n\nThis is the configuration descriptor containing the malicious value for \nbNumEndpoints causing the crash. A zero value for bNumEndpoints crashes the system.\n\n\t[*] Configuration-Descriptor\n\t  bLength:\t\t0x9\n\t  bDescriptorType:\t0x2\n\t  wTotalLength:\t\t0x27\n\t  bNumInterfaces:\t0x1\n\t  bConfigurationValue:\t0x1\n\t  iConfiguration:\t0x0\n\t  bmAttributes:\t\t0x0\n\t  bMaxPower:\t\t0x31\n\t\t[*] Interface-Descriptor\n\t\t  bLength:\t\t0x9\n\t\t  bDescriptorType:\t0x4\n\t\t  bInterfaceNumber:\t0x0\n\t\t  bAlternateSetting:\t0x0\n\t\t  bNumEndpoints:\t0x0\n\t\t  bInterfaceClass:\t0x0\n\t\t  bInterfaceSubClass:\t0x0\n\t\t  bInterfaceProtocol:\t0x0\n\t\t\t[*] Endpoint-Descriptor\n\t\t\t  bLength:\t\t0x7\n\t\t\t  bDescriptorType:\t0x5\n\t\t\t  bEndpointAddress:\t0x81  \n\t\t\t  bmAttribut:\t\t0x3   \n\t\t\t  wMaxPacketSize:\t0x404\n\t\t\t  bInterval:\t\t0xc\n\t\t\t[*] Endpoint-Descriptor\n\t\t\t  bLength:\t\t0x7\n\t\t\t  bDescriptorType:\t0x5\n\t\t\t  bEndpointAddress:\t0x1   \n\t\t\t  bmAttribut:\t\t0x2   \n\t\t\t  wMaxPacketSize:\t0x4\n\t\t\t  bInterval:\t\t0xc\n\t\t\t[*] Endpoint-Descriptor\n\t\t\t  bLength:\t\t0x7\n\t\t\t  bDescriptorType:\t0x5\n\t\t\t  bEndpointAddress:\t0x82  \n\t\t\t  bmAttribut:\t\t0x2   \n\t\t\t  wMaxPacketSize:\t0x4\n\t\t\t  bInterval:\t\t0xc\n\nThe wacom driver assumes that there will be at least one endpoint-descriptor.\nIf the interface-descriptor contains a zero-value for bNumEndpoints or no endpoint-descriptor is provided, the driver tries to dereference a null-pointer and the kernel crashes:\n\n****\n$ nm wacom.ko.debug | grep wacom_probe\n00000000000054a0 t wacom_probe\n$ addr2line -e wacom.ko.debug 0x5756\n/usr/src/debug/kernel-3.10.0-229.14.1.el7/linux-3.10.0-229.14.1.el7.x86_64/drivers/input/tablet/wacom_sys.c:599\n****\n\n**** CentOS-Kernel linux-3.10.0-229.14.1.el7 (drivers/input/tablet/wacom-sys.c)\n        ...\n597\terror = usb_get_extra_descriptor(interface, HID_DEVICET_HID, &hid_desc);\n598\tif (error) {\n599\t\terror = usb_get_extra_descriptor(&interface->endpoint[0], /* possible null-pointer dereference */\n600\t\t\t\t\t\t HID_DEVICET_REPORT, &hid_desc);\n        ...\n****\n\nProof of Concept:\n1) The bug can be reproduced using USB-fuzzing framework vUSBf from Sergej Schumilo (github.com/schumilo). \nThe attached vUSBf-obj file contains the payload. Please let us know if you would like to use the Facedancer board. \nIn such case, we could also provide a patched version of vUSBf which allows to reproduce vUSBf-Payloads using the Facedancer board.\n2) For a proof of concept we are providing also an Arduino firmware file. Just flash it \non Arduino Leonardo and plug it into any RHEL machine. The Arduino will \nemulate the defective USB device.\n\n   avrdude -v -p ATMEGA32u4 -c avr109 -P /dev/ttyACM0 -b 57600 -U flash:w:binary.hex\n\nThe file binary.hex has been attached to this bug report.\nTo prevent automated sending of payloads, use a jumper to connect port D3 and \n5V!\n\n\nSeverity and Ease of Exploitation\nThe security weakness can be easily exploited. Using our Arduino firmware only \nphysical access to the system is required. \n\n\nAdditional info:\nStacktrace, vUSBf-Payload, Arduino-Firmware attached.\n\n\nPlease assign a CVE for this issue since this is a local DoS of the targeted system. \nCVSS 4.9 (AV:L/AC:L/Au:N/C:N/I:N/A:C)",
        "Createdattachment 1096290[details]vUSBf Payload",
        "Createdattachment 1096291[details]Stacktrace",
        "Createdattachment 1096293[details]Arduino firmware demonstrating the bug",
        "This bz andbz1283375are related, as both are caused by the same issue, zero endpoints, while the driver expects at least one endpoint to be present. The bug is that the driver does not check that at least one endpoint is present and accesses the first endpoint causing null-ptr deref. Crashes in these 2 bzs are in the different places because of the different execution paths.\n\n[ drivers/input/tablet/wacom_sys.c ]\nstatic int wacom_probe(struct usb_interface *intf, const struct usb_device_id *id)\n{       ...\n        endpoint = &intf->cur_altsetting->endpoint[0].desc; <<< This is NULL\n        ...\n        error = wacom_retrieve_hid_descriptor(intf, features);\n\nstatic int wacom_retrieve_hid_descriptor(struct usb_interface *intf ...\n{       ...\n        struct usb_host_interface *interface = intf->cur_altsetting;\n        ...\n        error = usb_get_extra_descriptor(interface, HID_DEVICET_HID, &hid_desc);\n        if (error) {\n                error = usb_get_extra_descriptor(&interface->endpoint[0], <<< This is #define\n                HID_DEVICET_REPORT, &hid_desc);\n\n#define usb_get_extra_descriptor(ifpoint, type, ptr) \\\n__usb_get_extra_descriptor((ifpoint)->extra, (ifpoint)->extralen, \\  <<< rdi rsi\ntype, (void **)ptr)                                                  <<< rdx rcx\n\n  1e:   49 8b 46 18          \tmov    0x18(%r14),%rax\n  22:   48 8d 4d c8          \tlea    -0x38(%rbp),%rcx\n  26:   ba 22 00 00 00       \tmov    $0x22,%edx       <<< HID_DEVICET_REPORT>>2b:*  8b 70 38             \tmov    0x38(%rax),%esi  <<< endpoint->extralen *BOOM*2e:   48 8b 78 30          \tmov    0x30(%rax),%rdi  <<< endpoint->extra\n  32:   e8 ae 2c 07 e1       \tcallq  0xffffffffe1072ce5\n\nThe upstream driver was rebased and does not have this bug, so this bug is rhel7-only. The fix is to check the number of endpoints (as it was done in [aiptek] driver fix athttp://www.spinics.net/lists/linux-input/msg42294.html, [aiptek] was based on [wacom]). Rhel7 patch follows.",
        "Createdattachment 1099055[details]wacom-null-deref.rhel7.patch",
        "Public via:http://seclists.org/bugtraq/2016/Mar/60",
        "CVEID was requested at:http://seclists.org/oss-sec/2016/q1/606",
        "CVE-2016-3139was assigned to this flaw, please, use it in the related communications, seehttp://seclists.org/oss-sec/2016/q1/623.",
        "Thank you for reporting this flaw.\n\nThe Product Security has rated this flaw as having low security impact (bz1316993), so the patch currently is not planned to be added to the RHEL source trees. The upstream and Fedora is rebased, so the fix may get to the RHEL trees at the next USB subsystem code rebase."
    ]
}