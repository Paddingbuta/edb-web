{
    "bugid": "727800",
    "cveid": [
        "CVE-2011-2896"
    ],
    "summary": "CVE-2011-2896 David Koblas' GIF decoder LZW decoder buffer overflow",
    "alias": "CVE-2011-2896",
    "product": "Security Response",
    "hardware": "All",
    "os": "Linux",
    "url": "",
    "reported_date": "2011-08-03 09:22 UTC byTomas Hoger",
    "attachment": [
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=516471"
    ],
    "comment": [
        "GIF image file format readers in various open source projects are based on the GIF decoder implementation written by David Koblas.  This implementation contains a bug in the LZW decompressor, causing it to in correctly handle compressed streams that contain code words that were not yet added to the decompression table.  LZW decompression has a special case (a KwKwK string) when code word may match the first free entry in the decompression table.  The implementation used in this GIF reading code allows code words not only matching, but also exceeding the first free entry.\n\nThis problem is identical to a bug found in BSD compress (CVE-2011-2895,bug #727624), but given the unclear relationship between BSD compress and GIF decoder code bases, separate CVE is used here.\n\nSeveral projects refer to pbmplus as the source form where GIF reading code was taken:http://www.acme.com/software/pbmplus/In pbmplus version of the code, the flaw can be found in LWZReadByte():\n\n        if (code >= max_code) {\n            *sp++ = firstcode;\n            code = oldcode;\n        }\n\nThis allows creating a loop in the decompression table, which leads to an \"infinite\" loop:\n\n        while (code >= clear_code) {\n            *sp++ = table[1][code];\n            if (code == table[0][code])\n                pm_error(\"circular table entry BIG ERROR\");\n            code = table[0][code];\n        }\n\nwhere:\n\n  #define MAX_LWZ_BITS        12\n  static int  table[2][(1<< MAX_LWZ_BITS)];\n  static int  stack[(1<<(MAX_LWZ_BITS))*2], *sp;\n  sp = stack;\n\nThis results in stack[] buffer overflow.  If table[][] is located above stack[], stack[] overflow may further modify decoding table and break infinite loop.",
        "Createdattachment 516471[details]giftoppm.c\n\nLocal copy of the giftoppm.c, extracted from pbmplus_10dec1991.tar.gz, available from:http://www.acme.com/software/pbmplus/",
        "Createdattachment 516472[details]Test case\n\nFrombug #714118, already public viahttp://cups.org/str.php?L3867",
        "As noted above, this GIF reader code is used in several open source projects.  Many of them have already correct this bug, either by rejecting code > max_code, or by checking for stack[] overflow.\n\ntk - code > max_code checkhttp://core.tcl.tk/tk/artifact/c0026f5eee240f40fe716e235d28c0818b981ab7gd - stack overflow checkhttp://svn.php.net/viewvc/gd/trunk/libgd/src/gd_gif_in.c?revision=282370&view=markup#l512gdk-pixbuf - stack overflow checkhttp://git.gnome.org/browse/gdk-pixbuf/tree/gdk-pixbuf/io-gif.c?id=f8569bb1#n656CUPS was fixed recently (in 1.4.7) and now does code > max_code checkhttp://cups.org/str.php?L3867svn diff -c 9840http://svn.easysw.com/public/cups/GIMP is still affected:http://git.gnome.org/browse/gimp/tree/plug-ins/common/file-gif-load.c?id=8ff66342#n810XPCE is still affected:http://www.swi-prolog.org/git/packages/xpce.git/blob/876ce515:/src/img/gifread.c#l507There are several other projects that contain very similar code, but their relationship to David Koblas' code is unclear.  Mentioning them here for the sake of completeness.  They contain stack overflow check.  They include libpr0n/mozilla/webkit code as well as Qt:http://hg.mozilla.org/mozilla-central/file/c4b84b05c46c/modules/libpr0n/decoders/nsGIFDecoder2.cpp#l500http://trac.webkit.org/browser/trunk/Source/WebCore/platform/image-decoders/gif/GIFImageReader.cpp?rev=75748#L309http://qt.gitorious.org/qt/qt/blobs/4.5/src/plugins/imageformats/gif/qgifhandler.cpp#line484",
        "(In reply tocomment #4)> CUPS was fixed recently (in 1.4.7) and now does code > max_code check\n>http://cups.org/str.php?L3867> svn diff -c 9840http://svn.easysw.com/public/cups/Additional change is required to fully address the problem in CUPS:http://www.cups.org/str.php?L3914svn diff -c 9865http://svn.easysw.com/public/cups/",
        "Making this public.",
        "Created gimp tracking bugs for this issue\n\nAffects: fedora-all [bug 730338]",
        "(In reply tocomment #4)> GIMP is still affected:\n>http://git.gnome.org/browse/gimp/tree/plug-ins/common/file-gif-load.c?id=8ff66342#n810Upstream git commit:http://git.gnome.org/browse/gimp/commit/plug-ins/common/file-gif-load.c?id=376ad788c1a1c31d40f18494889c383f6909ebfc",
        "(In reply tocomment #4)> \n> XPCE is still affected:\n>http://www.swi-prolog.org/git/packages/xpce.git/blob/876ce515:/src/img/gifread.c#l507>I've sent a report to SWI Prolog bug tracking system\n(http://www.swi-prolog.org/bugzilla/show_bug.cgi?id=7).",
        "(In reply tocomment #12)> I've sent a report to SWI Prolog bug tracking system\n> (http://www.swi-prolog.org/bugzilla/show_bug.cgi?id=7).Thank you!  Upstream did following commits to address the issue:http://www.swi-prolog.org/git/packages/xpce.git/commitdiff/bb328029beb148691edc031d9db9cf0a503c8247http://www.swi-prolog.org/git/packages/xpce.git/commitdiff/30fbc4e030cbef5871e1b96c31458116ce3e2ee8Additionally, aCVE-2006-4484/CVE-2007-6697/CVE-2008-0553/CVE-2008-0554/CVE-2008-1373/CVE-2011-2897-like crash was corrected:http://www.swi-prolog.org/git/packages/xpce.git/commitdiff/785efb7b94d28c7dbb5b4f2b6f5a908092cf7652",
        "Created pl tracking bugs for this issue\n\nAffects: fedora-all [bug 731944]",
        "Created cups tracking bugs for this issue\n\nAffects: fedora-all [bug 731951]",
        "(In reply tocomment #14)> (In reply tocomment #12)\n> > I've sent a report to SWI Prolog bug tracking system\n> > (http://www.swi-prolog.org/bugzilla/show_bug.cgi?id=7).\n> \n> Thank you!  Upstream did following commits to address the issue:\n> \n>http://www.swi-prolog.org/git/packages/xpce.git/commitdiff/bb328029beb148691edc031d9db9cf0a503c8247>http://www.swi-prolog.org/git/packages/xpce.git/commitdiff/30fbc4e030cbef5871e1b96c31458116ce3e2ee8> \n> Additionally, aCVE-2006-4484/CVE-2007-6697/CVE-2008-0553/CVE-2008-0554/\n>CVE-2008-1373/CVE-2011-2897-like crash was corrected:\n> \n>http://www.swi-prolog.org/git/packages/xpce.git/commitdiff/785efb7b94d28c7dbb5b4f2b6f5a908092cf7652After applying all three patches on 5.10.2 version from Fedora 15, and loading `Minimal test case with valid first code' test case, I get segfault in PutImagePixels32(), a Xorg libXpm library, after 4 calls of LZWReadByte():\n\n?- show('xpce-gif-CVE-2011-2896/giflzw-1-260-259-260-260-0-first_code_valid.gif').\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x000000376ca093c6 in PutImagePixels32 (pixels=0x8c2540, pixelindex=0x8c23a0, \n    height=10, width=10, image=<optimized out>) at create.c:1384\n1384                    pixel = pixels[*(iptr++)];\n(gdb) bt\n#0  0x000000376ca093c6 in PutImagePixels32 (pixels=0x8c2540, \n    pixelindex=0x8c23a0, height=10, width=10, image=<optimized out>)\n    at create.c:1384\n#1  XpmCreateImageFromXpmImage (display=0x8737d0, image=0x7fffffffd3e0, \n    image_return=0x7fffffffd388, shapeimage_return=0x7fffffffd390, \n    attributes=0x7fffffffd290) at create.c:881\n#2  0x00007ffff15b5135 in attachXpmImageImage (image=0x8b3350, \n    xpm=0x7fffffffd3e0) at x11/xconvert.c:468\n#3  0x00007ffff15b5394 in readGIFFile (fd=0x8a6660, image=0x8b3350)\n    at x11/xconvert.c:537\n[...]\n\n(gdb) info locals \ndata = 0x8c25c0 \"\\377\\377\\377\"\ny = <optimized out>\niptr = 0x8c23a8\npixel = <optimized out>\nbpl = 40\ndata_ptr = 0x8c25c8 \"\\370T\\031_7\"\nmax_data = 0x8c25e8 \"\"\n\nI guess this is because pl/xpce decodes the GIF image erroneously and decoded image size does not match image bitmap. However this test case is private, so I cannot provide it to upstream.",
        "Statement:\n\nVulnerable. This issue affects the versions of cups as shipped with Red Hat Enterprise Linux 4, 5, and 6. The Red Hat Security Response Team has rated this issue as having moderate security impact for the cups package. A future update may address this issue in the cups package for Red Hat Enterprise Linux 4, 5, and 6. For additional information, refer to the Issue Severity Classification:https://access.redhat.com/security/updates/classification/.",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 6\n\nVia RHSA-2011:1635https://rhn.redhat.com/errata/RHSA-2011-1635.html",
        "(In reply tocomment #8)> Additional change is required to fully address the problem in CUPS:\n>http://www.cups.org/str.php?L3914> svn diff -c 9865http://svn.easysw.com/public/cups/Note this also got a separate CVECVE-2011-3170,bug #732106.",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 5\n\nVia RHSA-2012:0302https://rhn.redhat.com/errata/RHSA-2012-0302.html",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 6\n\nVia RHSA-2012:1180https://rhn.redhat.com/errata/RHSA-2012-1180.html",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 5\n\nVia RHSA-2012:1181https://rhn.redhat.com/errata/RHSA-2012-1181.html",
        "*** Bug 260998 has been marked as a duplicate of this bug. ***\nSeen from the domainhttp://volichat.comPage where seen:http://volichat.com/teen-chat-roomsMarked for reference. Resolved as fixed @bugzilla.",
        "Affected code is also part of pl as shipped with Red Hat Enterprise Linux 6.  That package is only provided via Optional repository with limited support, there is currently no plan to address this issue in future pl package updates in Red Hat Enterprise Linux 6."
    ]
}