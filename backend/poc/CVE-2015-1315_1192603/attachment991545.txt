...
static void charset_to_intern(char *string, char *from_charset)
{
    iconv_t cd; 
    char *s,*d, *buf;
    size_t slen, dlen, buflen;
    const char *local_charset;
    
    if(*from_charset == '\0')
       return;
    
    buf = NULL;
    local_charset = nl_langinfo(CODESET);
    
    if((cd = iconv_open(local_charset, from_charset)) == (iconv_t)-1)
        return;
    
    slen = strlen(string);
    s = string;
    dlen = buflen = 2*slen; 
    d = buf = malloc(buflen + 1);
    if(!d)
       goto cleanup;
    bzero(buf,buflen);
    if(iconv(cd, &s, &slen, &d, &dlen) == (size_t)-1)
       goto cleanup;
    strncpy(string, buf, buflen);
    
    cleanup:
    free(buf);
    iconv_close(cd);
}
...
