From f08e7af4e3272acd53ed9743be65d30ca445700c Mon Sep 17 00:00:00 2001
From: Andreas Schwab <schwab@redhat.com>
Date: Mon, 18 Oct 2010 11:46:00 +0200
Subject: [PATCH] Never expand $ORIGIN in privileged programs

2010-10-18  Andreas Schwab  <schwab@redhat.com>

	* elf/dl-load.c (is_dst): Rename last parameter to is_origin and
	only check that $ORIGIN appears first.
	(_dl_dst_count): Never expand $ORIGIN in privileged programs.
	(_dl_dst_substitute): Likewise.
---
 elf/dl-load.c |   18 ++++++++----------
 1 files changed, 8 insertions(+), 10 deletions(-)

diff --git a/elf/dl-load.c b/elf/dl-load.c
index a7162eb..367765e 100644
--- a/elf/dl-load.c
+++ b/elf/dl-load.c
@@ -170,7 +170,7 @@ local_strdup (const char *s)
 
 static size_t
 is_dst (const char *start, const char *name, const char *str,
-	int is_path, int secure)
+	int is_path, int is_origin)
 {
   size_t len;
   bool is_curly = false;
@@ -199,9 +199,7 @@ is_dst (const char *start, const char *name, const char *str,
 	   && (!is_path || name[len] != ':'))
     return 0;
 
-  if (__builtin_expect (secure, 0)
-      && ((name[len] != '\0' && (!is_path || name[len] != ':'))
-	  || (name != start + 1 && (!is_path || name[-2] != ':'))))
+  if (is_origin && name != start + 1 && (!is_path || name[-2] != ':'))
     return 0;
 
   return len;
@@ -218,11 +216,11 @@ _dl_dst_count (const char *name, int is_path)
     {
       size_t len;
 
-      /* $ORIGIN is not expanded for SUID/GUID programs (except if it
-	 is $ORIGIN alone) and it must always appear first in path.  */
+      /* $ORIGIN is not expanded for SUID/GUID programs and it must
+	 always appear first in path.  */
       ++name;
-      if ((len = is_dst (start, name, "ORIGIN", is_path,
-			 INTUSE(__libc_enable_secure))) != 0
+      if ((!INTUSE(__libc_enable_secure)
+	   && (len = is_dst (start, name, "ORIGIN", is_path, 1)) != 0)
 	  || (len = is_dst (start, name, "PLATFORM", is_path, 0)) != 0
 	  || (len = is_dst (start, name, "LIB", is_path, 0)) != 0)
 	++cnt;
@@ -256,8 +254,8 @@ _dl_dst_substitute (struct link_map *l, const char *name, char *result,
 	  size_t len;
 
 	  ++name;
-	  if ((len = is_dst (start, name, "ORIGIN", is_path,
-			     INTUSE(__libc_enable_secure))) != 0)
+	  if (!INTUSE(__libc_enable_secure)
+	      && (len = is_dst (start, name, "ORIGIN", is_path, 1)) != 0)
 	    {
 #ifndef SHARED
 	      if (l == NULL)
-- 
1.7.2.3

