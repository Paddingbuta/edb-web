{
    "bugid": "727624",
    "cveid": [
        "CVE-2011-2895"
    ],
    "summary": "CVE-2011-2895 BSD compress LZW decoder buffer overflow",
    "alias": "CVE-2011-2895",
    "product": "Security Response",
    "hardware": "All",
    "os": "Linux",
    "url": "",
    "reported_date": "2011-08-02 16:00 UTC byTomas Hoger",
    "attachment": [
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=516375"
    ],
    "comment": [
        "BSD compress implemented an LZW compressor and decompressor.  This decompressor implementation did not correctly handle compressed streams that contain code words that were not yet added to the decompression table.  LZW decompression has a special case (a KwKwK string) when code word may match the first free entry in the decompression table.  The implementation used in BSD compress allow code words not only matching, but also exceeding the first free entry.\n\nIt seems this compress implementation first appeared in BSD around 1985, and was later used in various other code base, such as ncompress and gzip.  Other components that contain affected code will be listed below.  Following page list the version of the code as was used in 4.3BSD:http://minnie.tuhs.org/cgi-bin/utree.pl?file=4.3BSD-Reno/src/usr.bin/compress/compress.cRelevant code appears in the decompress() routine:\n\n\t/*\n\t * Special case for KwKwK string.\n\t */\n\tif ( code >= free_ent ) {\n            *stackp++ = finchar;\n\t    code = oldcode;\n\t}\n\nThis allows creating a loop in the decompression table, which leads to an \"infinite\" loop:\n\n\t/*\n\t * Generate output characters in reverse order\n\t */\n#ifdef SIGNED_COMPARE_SLOW\n\twhile ( ((unsigned long)code) >= ((unsigned long)256) ) {\n#else\n\twhile ( code >= 256 ) {\n#endif\n\t    *stackp++ = tab_suffixof(code);\n\t    code = tab_prefixof(code);\n\t}\n\nwhere tab_prefixof is:\n\n  unsigned short codetab [HSIZE];\n  #define codetabof(i)\tcodetab[i]\n  #define tab_prefixof(i)\tcodetabof(i)\n\nThis overflows de_stack \"buffer\" (part of the htab[]):\n\n  count_int htab [HSIZE];\n  # define tab_suffixof(i)\t((char_type *)(htab))[i]\n  # define de_stack\t\t((char_type *)&tab_suffixof(1<<BITS))\n\nDepending on the relative htab[] and codetab[] positions, de_stack overflow may overwrite codetab[] entries, which may break infinite loop and let program continue its execution with possibly corrupted memory.",
        "Following projects embed this BSD compress code and have fixed this issue already, either by aborting compression when code > free_ent is encountered, or by protecting against de_stack overflow in the while loop.\n\nncompress - code > free_ent checkhttp://ncompress.git.sourceforge.net/git/gitweb.cgi?p=ncompress/ncompress;a=blob;f=compress.c;h=c16e1239#l1167gzip - code > free_ent checkhttp://git.savannah.gnu.org/gitweb/?p=gzip.git;a=blob;f=unlzw.c;h=63f941c6#l297libarchive - code > free_ent checkhttp://code.google.com/p/libarchive/source/browse/trunk/libarchive/archive_read_support_filter_compress.c?r=3195#375busybox's libarchive - code > free_ent checkhttp://git.busybox.net/busybox/tree/archival/libarchive/decompress_uncompress.c?id=833d4e7f#n220OpenBSD compress - stack overflow checkhttp://www.openbsd.org/cgi-bin/cvsweb/src/usr.bin/compress/zopen.c#rev1.17It seems this fix never made it to other BSDs as FreeBSD or NetBSD.\n\nThe version from NetBSD was used in older freetype versions for some time:http://git.savannah.gnu.org/cgit/freetype/freetype2.git/log/src/lzw/zopen.chttp://git.savannah.gnu.org/cgit/freetype/freetype2.git/tree/src/lzw/zopen.c?id=a1c990a6#n251freetype version in Red Hat Enterprise Linux 4 (2.1.9) contains the code and is affected by this issue.\n\nlibXfont contains affected version of the code too:http://cgit.freedesktop.org/xorg/lib/libXfont/tree/src/fontfile/decompress.c?id=f29f1d68#n249More details can be found inbug #725760.\n\nHeirloom mailx / nail lzw.c should be based on FreeBSD code:http://nail.cvs.sourceforge.net/viewvc/nail/nail/lzw.c?revision=1.4&view=markup#l511The code is used to compress and decompress imap cache file and spam filter database, and is not used to decompress untrusted inputs.",
        "Createdattachment 516375[details]4.3BSD compress.c\n\nLocal copy of the file from:http://minnie.tuhs.org/cgi-bin/utree.pl?file=4.3BSD-Reno/src/usr.bin/compress/compress.c",
        "(In reply tocomment #1)> busybox's libarchive - code > free_ent check\n>http://git.busybox.net/busybox/tree/archival/libarchive/decompress_uncompress.c?id=833d4e7f#n220It seems I was wrong about busybox.  Different code path is used for the first code word.  I'll need to work on additional reproducers to test both code paths.",
        "(In reply tocomment #5)> It seems I was wrong about busybox.  Different code path is used for the first\n> code word.  I'll need to work on additional reproducers to test both code\n> paths.This problem was previously fixed in ncompress asCVE-2006-1168, seebug #201919.  busybox code based on ncompress.",
        "Making this public.",
        "(In reply tocomment #1)> libXfont contains affected version of the code too:libXfont fixed upstream in version 1.4.4:http://lists.freedesktop.org/archives/xorg-announce/2011-August/001721.htmlhttp://lists.freedesktop.org/archives/xorg-announce/2011-August/001722.htmlhttp://cgit.freedesktop.org/xorg/lib/libXfont/commit/?id=d11ee5886e9d9ec610051a206b135a4cdc1e09a0",
        "This issue has been addressed in libXfont packages in following products:\n\n  Red Hat Enterprise Linux 5\n  Red Hat Enterprise Linux 6\n\nVia RHSA-2011:1154https://rhn.redhat.com/errata/RHSA-2011-1154.html",
        "This issue has been addressed in xorg-x11 packages in following products:\n\n  Red Hat Enterprise Linux 4\n\nVia RHSA-2011:1155https://rhn.redhat.com/errata/RHSA-2011-1155.html",
        "This issue has been addressed in freetype packages in following products:\n\n  Red Hat Enterprise Linux 4\n\nVia RHSA-2011:1161https://rhn.redhat.com/errata/RHSA-2011-1161.html",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 5.6.Z - Server Only\n\nVia RHSA-2011:1834https://rhn.redhat.com/errata/RHSA-2011-1834.html"
    ]
}