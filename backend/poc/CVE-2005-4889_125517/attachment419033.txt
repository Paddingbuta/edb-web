Index: fsm.c
===================================================================
RCS file: /v/rpm/cvs/rpm/lib/fsm.c,v
retrieving revision 2.112.2.1
retrieving revision 2.112.2.4
diff -p -u -w -r2.112.2.1 -r2.112.2.4
--- fsm.c	27 Sep 2005 16:01:18 -0000	2.112.2.1
+++ fsm.c	15 Nov 2005 20:06:53 -0000	2.112.2.4
@@ -1844,6 +1844,10 @@ if (!(fsm->mapFlags & CPIO_ALL_HARDLINKS
 	    if (rc == CPIOERR_ENOENT)
 		rc = fsmNext(fsm, FSM_MKNOD);
 	} else {
+	    /* XXX Repackaged payloads may be missing files. */
+	    if (fsm->repackaged)
+		break;
+
 	    /* XXX Special case /dev/log, which shouldn't be packaged anyways */
 	    if (!IS_DEV_LOG(fsm->path))
 		rc = CPIOERR_UNKNOWN_FILETYPE;
@@ -2127,6 +2131,14 @@ if (!(fsm->mapFlags & CPIO_ALL_HARDLINKS
 	/*@notreached@*/ break;
 
     case FSM_UNLINK:
+	/* XXX Remove setuid/setgid bits on possibly hard linked files. */
+	if (fsm->mapFlags & CPIO_SBIT_CHECK) {
+	    struct stat stb;
+	    if (Lstat(fsm->path, &stb) == 0 && S_ISREG(stb.st_mode) && (stb.st_mode & 06000) != 0) {
+		/* XXX rc = fsmNext(fsm, FSM_CHMOD); instead */
+		int xx = chmod(fsm->path, stb.st_mode & 0777);
+	    }
+	}
 	rc = Unlink(fsm->path);
 	if (_fsm_debug && (stage & FSM_SYSCALL))
 	    rpmMessage(RPMMESS_DEBUG, " %8s (%s) %s\n", cur,
@@ -2135,7 +2147,18 @@ if (!(fsm->mapFlags & CPIO_ALL_HARDLINKS
 	    rc = (errno == ENOENT ? CPIOERR_ENOENT : CPIOERR_UNLINK_FAILED);
 	break;
     case FSM_RENAME:
+	/* XXX Remove setuid/setgid bits on possibly hard linked files. */
+	if (fsm->mapFlags & CPIO_SBIT_CHECK) {
+	    struct stat stb;
+	    if (Lstat(fsm->path, &stb) == 0 && S_ISREG(stb.st_mode) && (stb.st_mode & 06000) != 0) {
+		/* XXX rc = fsmNext(fsm, FSM_CHMOD); instead */
+		int xx = chmod(fsm->path, stb.st_mode & 0777);
+	    }
+	}
 	rc = Rename(fsm->opath, fsm->path);
+	/* XXX Repackaged payloads may be missing files. */
+	if (fsm->repackaged)
+	    rc = 0;
 #if defined(ETXTBSY)
 	if (rc && errno == ETXTBSY) {
 	    char * path = alloca(strlen(fsm->path) + sizeof("-RPMDELETE"));
