#!/bin/bash

CERTPATH=/etc/ssl/certs
RPMBPREF=~/rpmbuild

CPEM=cert.pem
CKEY=cert.key

WD=`mktemp -dt`

function die
{
  echo $@
  exit 2
}

function check_install
{
  rpm --quiet -q "$@" || yum -y install "$@"
  rpm --quiet -q "$@" || die "Unable to install $@"
}

check_install postfix openssl gcc patch wget rpm-build yum-utils

if rpm --quiet -q sendmail
then
  rpm -e sendmail || die "Unable to remove sendmail"
fi

[ -d "$CERTPATH" ] || CERTPATH=/etc/postfix
CPCPEM="$CERTPATH/$CPEM"
CPCKEY="$CERTPATH/$CKEY"

pushd $WD

[ -f "$CPCPEM" ] && mv -f "$CPCPEM" "$WD/$CPEM"
[ -f "$CPCKEY" ] && mv -f "$CPCKEY" "$WD/$CKEY"

CF=`mktemp`

PEM=`mktemp`
cat << :eof | /usr/bin/openssl req -newkey rsa:2048 -keyout $CPCKEY -nodes -x509 -days 365 -out $PEM -set_serial 0 &> /dev/null || die "Unable to generate the cert"
CZ

Brno
Fedora

localhost
root@localhost
:eof

cat $CPCKEY > $CPCPEM
echo >> $CPCPEM
cat $PEM >> $CPCPEM
rm -f $PEM

service postfix stop
mv -f /etc/postfix/main.cf $WD/main.cf
cat << :eof > /etc/postfix/main.cf
queue_directory = /var/spool/postfix
command_directory = /usr/sbin
daemon_directory = /usr/libexec/postfix
data_directory = /var/lib/postfix
mail_owner = postfix
inet_interfaces = localhost
inet_protocols = all
unknown_local_recipient_reject_code = 550
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
sendmail_path = /usr/sbin/sendmail.postfix
newaliases_path = /usr/bin/newaliases.postfix
mailq_path = /usr/bin/mailq.postfix
setgid_group = postdrop
manpage_directory = /usr/share/man
smtpd_use_tls = yes
smtpd_tls_key_file = $CPCKEY
smtpd_tls_cert_file = $CPCPEM
smtpd_tls_loglevel = 3
:eof

service postfix start || die "Unable to run postfix"

REL=`rpm -q openssl | sed -n '$ {s/[^\-]\+\-[0-9a-zA-Z\.]\+\-\([0-9]\+\).*/\1/;p}'`
if [ "$REL" != "99" ]
then
  rm -rf $RPMBPREF/RPMS/*
  yumdownloader --source openssl ||
    die "Unable to install source package for openssl, do you have enabled the SRPM repo?"
  OPENSSL=openssl*
  yum-builddep --nogpgcheck -y ./$OPENSSL || die "Unable to install deps"
  rpm -i ./$OPENSSL
  cat <<':eof' > $RPMBPREF/SOURCES/openssl-rset.patch
--- openssl-0.9.8a/apps/s_client.c- 2009-12-16 15:28:28.000000000 -0500
+++ openssl-0.9.8a/apps/s_client.c 2011-01-12 13:44:08.000000000 -0500
@@ -1126,7 +1126,7 @@
 			BIO_printf(bio_err,
 				   "didn't found starttls in server response,"
 				   " try anyway...\n");
-		BIO_printf(sbio,"STARTTLS\r\n");
+		BIO_printf(sbio,"STARTTLS\r\nVRFY root@localhost\r\n");
 		BIO_read(sbio,sbuf,BUFSIZZ);
 		}
 	else if (starttls_proto == PROTO_POP3)
:eof


  [ -f ~/.rpmmacros ] && cp -f ~/.rpmmacros .
  echo '%_default_patch_fuzz 2' > ~/.rpmmacros
  echo '%_unpackaged_files_terminate_build 0' >> ~/.rpmmacros 

  sed -i 's/^Release:[ \t]*[0-9].*\+/Release: 99%{?dist}\nPatch999: openssl-rset.patch/;s/%patch0[ \t]\+.*/%patch999 -p1 -b \.rset\n\0/' $RPMBPREF/SPECS/openssl.spec ||
    die "Unable to patch openssl.spec"
  rpmbuild -bb $RPMBPREF/SPECS/openssl.spec || die "Unable to build openssl"
  OPENSSLRPM=`ls $RPMBPREF/RPMS/*/*.rpm | grep 'openssl-[0-9]'`
  [ "$OPENSSLRPM" ] || die "Unable to find openssl rpm"
  rpm -U "$OPENSSLRPM" || die "Unable to install patched openssl"
fi

echo quit | openssl s_client -quiet -starttls smtp -connect localhost:25 > $WD/res 2>&1
cat $WD/res | grep "root@localhost" || die "Error, unexpected result encountered"
cat $WD/res | grep "[0-9]\+ [0-9\.]* \?root@localhost"
NUM=$?

[ -f ./.rpmmacros ] && cp -f ./.rpmmacros ~/

service postfix stop
rm -f "$CPCPEM" "$CPCKEY"
[ -f "$WD/$CPEM" ] && mv -f "$WD/$CPEM" "$CPCPEM"
[ -f "$WD/$CKEY" ] && mv -f "$WD/$CKEY" "$CPCKEY"
mv -f $WD/main.cf /etc/postfix/main.cf
service postfix start
rm -rf $WD
popd

echo
if [ "$NUM" = "0" ]
then
  echo FAIL
  exit 1
else
  echo PASS
  exit 0
fi
