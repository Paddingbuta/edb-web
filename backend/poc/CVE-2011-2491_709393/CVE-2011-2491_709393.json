{
    "bugid": "709393",
    "cveid": [
        "CVE-2011-2491"
    ],
    "summary": "CVE-2011-2491 kernel: rpc task leak after flock()ing  NFS share",
    "alias": "CVE-2011-2491",
    "product": "Security Response",
    "hardware": "Unspecified",
    "os": "Linux",
    "url": "",
    "reported_date": "2011-05-31 15:31 UTC byVasily Averin",
    "attachment": [
        "https://bugzilla-attachments.redhat.com/attachment.cgi?id=502027"
    ],
    "comment": [
        "Createdattachment 502027[details]dmesg output with NFS/NLM/RPC debug\n\nbtw. I'm reporting this issue to akpm@ and to Trond Myklebust because other vendors and upstream linux kernel is affected too.\n\nDescription of problem:\nunprivileged user can use flock syscall for NFS share to trigger unlimited resource leak and this could cause node DoS.\n\nDetails:\nflock on NFS calls nlmclnt_lock() function, where nlmclnt_call() executes synchronous RPC task NLMPROC_LOCK. Via several subcalls (call_bind) it successfully connects to NFS server and decodes its reply, however because server did not set up r_port rpcb_getport_done() returns -EACCES, and following rpc subcall call_bind_status() in this case repeats call_bind() after 3 sec timeout.\n\nIt isn't a big problem, and this cycle could be broken by signal, however error path of nlmclnt_lock() executes identical asynchronous RPC call to unlock taken lock. Waiting of result of this call is also canceled by signal, however in this case RPC call is asynchronous, it cycles too and never finished.\n\nI would like to ask Trond to recheck my analyze and review my patch with fix of this issue or propose some better and more correct solution.\n\nMy idea is to break cycle described above, return -EOPNOTSUPP to nlmclnt_lock(), check it on error path and do not execute NLMPROC_UNLOCK call because we already know that server does not support locking operations.\n\nPS. one more separate issue: NLMPROC_UNLOCK can be cycled in another place: nlmclnt_unlock_callback() restarts RPC task in case of any errors. Therefore we cannot execute NLMPROC_UNLOCK on error path in case of server errors. I did not reproduce this issue, however I believe it's possible.\n\nPPS. Also I've found similar cycles in other nlm callbacks, however I have no ideas is it possible to exploit it. However I would like to ask Trond to review this code too.\n\nVersion-Release number of selected component (if applicable):\n2.6.32-131.0.15.el6.x86_64\nI've reproduced this issue on RHEL5, RHEL6, ubuntu 11.04 and upstream linux kernel 2.6.39. \n\nHow reproducible:\n100%\n\nActual results:\nflock hangs, can be canceled by signal, as result one more rpc task leaks\n(FYI: sysctl -w sunrpc.rpc_debug=0 dumps status of active RPC taks) \n\nExpected results:\nno hangs, no leaks\n\nAdditional info:\ndmesg output with NFS/NLM/RPC debug and concept of patch are attached.\nBecause  vendor-sec is no longer in use I'm preparing private report to akpm@ and to Trond Myklebust, probably they can propose some better solution",
        "Createdattachment 502030[details]patch for 2.6.39 kernel",
        "Createdattachment 502142[details]Proposed patch from Trond\n\nHow about something like the appended fix? It should deal with errors\nsuch as the rebind issue, but only after retrying a few times.\n\nCheers\n Trond",
        "Acknowledgements:\n\nRed Hat would like to thank Vasily Averin for reporting this issue.",
        "Upstream commit:http://git.kernel.org/linus/0b760113a3a155269a3fba93a409c640031dd68f",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 6\n\nVia RHSA-2011:1189https://rhn.redhat.com/errata/RHSA-2011-1189.html",
        "This issue has been addressed in following products:\n\n  MRG for RHEL-6 v.2\n\nVia RHSA-2011:1253https://rhn.redhat.com/errata/RHSA-2011-1253.html",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 5\n\nVia RHSA-2011:1212https://rhn.redhat.com/errata/RHSA-2011-1212.html",
        "This issue has been addressed in following products:\n\n  Red Hat Enterprise Linux 5.6.Z - Server Only\n\nVia RHSA-2011:1813https://rhn.redhat.com/errata/RHSA-2011-1813.html"
    ]
}