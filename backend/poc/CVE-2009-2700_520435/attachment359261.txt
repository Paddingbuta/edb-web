/*
 * g++ qtclient.cc -I/usr/include/QtCore -I/usr/include/QtNetwork -lQtCore -lQtNetwork
 */

#include <QSslSocket>
#include <QSslCertificate>
#include <QFile>

int main(int argc, char* argv[]) {
	QSslSocket socket;

	char *host;
	int port;

	if (argc < 3) {
		qDebug() << "usage: a.out host port [cacert]";
		return 1;
	}

	host = argv[1];
	port = atoi(argv[2]);

	qDebug() << "Connecting to:" << host << port;
	qDebug();

	if (argc >= 4) {
		QFile certfile(argv[3]);
		certfile.open(QIODevice::ReadOnly | QIODevice::Text);

		QSslCertificate cert(&certfile, QSsl::Pem);

		qDebug() << "Adding CA cert file:" << argv[3];
		qDebug() << "  Subject:" << cert.subjectInfo(QSslCertificate::CommonName);
		qDebug() << "  Issuer:" << cert.issuerInfo(QSslCertificate::CommonName);
		qDebug();
		socket.addCaCertificate(cert);
	}

	socket.connectToHostEncrypted(host, port);
 	if (!socket.waitForEncrypted()) {
		qDebug() << "SSL Error occurred:" << socket.errorString();
		//return 1;
	} else {
		qDebug() << "All OK...";
	}

	qDebug();
	QSslCertificate peercert = socket.peerCertificate();
	qDebug() << "Peer certificate:";
	qDebug() << "  Subject:" << peercert.subjectInfo(QSslCertificate::CommonName);
	qDebug() << "  Issuer:" << peercert.issuerInfo(QSslCertificate::CommonName);
	qDebug();

	return 0;
}
