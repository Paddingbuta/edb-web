#!/bin/bash
#
# Copyright (c) halfdog <me (%) halfdog.net>
#
# This software is provided by the copyright owner "as is" to
# study it but without any expressed or implied warranties, that
# this software is fit for any other purpose. If you try to compile
# or run it, you do it solely on your own risk and the copyright
# owner shall not be liable for any direct or indirect damage
# caused by this software.

echo "pre-run, make sure ps is working"
ps aux | tail -3

killall DirModifyInotify
killall FuseMinimal

if [ -L tmp ]; then
    rm -f tmp
fi
if [ -d tmp-moved ]; then
    rm -rf tmp-moved
fi
if [ -d tmp-moved ]; then
    sudo umount tmp-moved/proc && rm -rf tmp-moved
fi

if [ ! -x DirModifyInotify -o ! -x FuseMinimal ]; then
    make compile
fi

mkdir -p tmp/proc
(cd tmp/proc; sleep 1; ../../FuseMinimal .) &
(./DirModifyInotify --Watch tmp/proc --Watch /etc/mtab --WatchCount 8 --MovePath tmp --LinkTarget /) &
sleep 3
fusermount -u -z /proc/
# Check that proc was unmounted by running ps
echo "post-run, is ps still working?"
ps aux | tail -3
