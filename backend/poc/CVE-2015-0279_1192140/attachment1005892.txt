From e2f902a47f779a1f63fc38f5e74a05e2b53771dc Mon Sep 17 00:00:00 2001
From: Michal Petrov <mpetrov@redhat.com>
Date: Mon, 09 Mar 2015 15:25:29 +0000
Subject: https://issues.jboss.org/browse/WFK2-879 - prevent method execution in mediaOutput

---
diff --git a/components/a4j/src/main/java/org/richfaces/resource/MediaOutputResource.java b/components/a4j/src/main/java/org/richfaces/resource/MediaOutputResource.java
index c738d25..87eb0aa 100644
--- a/components/a4j/src/main/java/org/richfaces/resource/MediaOutputResource.java
+++ b/components/a4j/src/main/java/org/richfaces/resource/MediaOutputResource.java
@@ -25,6 +25,7 @@ import java.io.OutputStream;
 import java.util.Date;
 import java.util.HashMap;
 import java.util.Map;
+import java.util.regex.Pattern;
 
 import javax.el.MethodExpression;
 import javax.el.ValueExpression;
@@ -47,6 +48,8 @@ public class MediaOutputResource extends AbstractUserResource implements StateHo
     private boolean cacheable;
     private MethodExpression contentProducer;
     private ValueExpression expiresExpression;
+
+    private static final String PARENTHESES = "[^\\(]*";
     /*
      * TODO: add handling for expressions:
      *
@@ -59,6 +62,12 @@ public class MediaOutputResource extends AbstractUserResource implements StateHo
 
     public void encode(FacesContext facesContext) throws IOException {
         OutputStream outStream = facesContext.getExternalContext().getResponseOutputStream();
+        String expr = contentProducer.getExpressionString();
+
+        if (!Pattern.matches(PARENTHESES, expr)) { // method expression must not be executed
+            throw new IllegalArgumentException("Expression \"" + expr + "\" contains parentheses.");
+        }
+
         contentProducer.invoke(facesContext.getELContext(), new Object[] { outStream, userData });
     }
 
--
cgit v0.9.2
