From 2881f8b260c03df29afb0e35e6d1707240f95ad7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Miloslav=20Trma=C4=8D?= <mitr@redhat.com>
Date: Tue, 1 Jul 2014 20:00:48 +0200
Subject: [PATCH 08/12] Prevent builds against SpiderMonkey with exact stack
 rooting
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

“Exact stack rooting” means that every on-stack pointer to a JavaScript
value needs to be registered with the runtime.  The current code doesn't
do this, so it is not safe to use against a runtime with this
configuration.  Luckily this configuration is not default.

See
https://developer.mozilla.org/en-US/docs/SpiderMonkey/Internals/GC/Exact_Stack_Rooting
and other pages in the wiki for what the conversion would require.

https://bugs.freedesktop.org/show_bug.cgi?id=69501
---
 src/polkitbackend/polkitbackendjsauthority.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/polkitbackend/polkitbackendjsauthority.c b/src/polkitbackend/polkitbackendjsauthority.c
index 39f7060..22812a6 100644
--- a/src/polkitbackend/polkitbackendjsauthority.c
+++ b/src/polkitbackend/polkitbackendjsauthority.c
@@ -43,6 +43,13 @@
 
 #include "initjs.h" /* init.js */
 
+#ifdef JSGC_USE_EXACT_ROOTING
+/* See https://developer.mozilla.org/en-US/docs/SpiderMonkey/Internals/GC/Exact_Stack_Rooting
+ * for more information about exact stack rooting.
+ */
+#error "This code is not safe in SpiderMonkey exact stack rooting configurations"
+#endif
+
 /**
  * SECTION:polkitbackendjsauthority
  * @title: PolkitBackendJsAuthority
-- 
2.4.3

