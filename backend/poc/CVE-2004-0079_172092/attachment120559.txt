#!/usr/bin/perl -w

require 5.003;
use strict;
use Socket;

exit(main());

sub
main
{
	my($i, $host, $port);

	for ($i = 0; $i <= $#ARGV; $i++) {
		if ($ARGV[$i] eq '-h' && $#ARGV >= $i + 1) {
			$host = $ARGV[$i + 1];
			$i++;
		} elsif ($ARGV[$i] eq '-p' && $#ARGV >= $i + 1) {
			$port = $ARGV[$i + 1];
			$i++;
		} else {
			print "Usage: $0 -h host [-p port]\n";
			exit(1);
		}
	}
	if ($host =~ /^\s*$/) {
		print "Usage: $0 -h host [-p port]\n";
		exit(1);
	}
	if ($port !~ /^\d+$/) {
		$port = 80;
	}

	my($chello) = pack("C11", 22, 03, 01, 00, 06, 01, 00, 00, 22, 03, 01);
	my($change_cipher) = pack("C6", 20, 03, 01, 00, 01, 01);

	print "# connect $host:$port\n";
	my($addr) = inet_aton($host);
	my($name) = pack_sockaddr_in($port, $addr);

	my($proto) = (getprotobyname('tcp'))[2];
	socket(S, PF_INET, SOCK_STREAM, $proto);
	connect(S, $name);
	select(S);
	$| = 1;
	select(STDOUT);

	print(S $chello);
	print(S $change_cipher);
	while (<S>) {
		print;
	}
	close(S);
	return(0);
}
