#!/bin/sh

tmp_httpd_conf=/tmp/httpd.conf.test
httpd_conf=/etc/httpd/conf/httpd.conf
org_httpd_conf=/tmp/httpd.conf.original

service httpd stop

cd /var/www/html/test/

cp -f ${httpd_conf} ${org_httpd_conf}

for options in None IncludesNoExec Includes
do
    printf "Testing with httpd.conf Options ${options}\n"
    for allowoverride in "Options=IncludesNoExec" "Options=Includes" All None
    do
        printf "\n  Testing with httpd.conf AllowOverride ${allowoverride}\n"
        for htaccess in "+Includes" "+IncludesNoExec" Includes IncludesNoExec
        do
            printf "    + .htaccess: ${htaccess}... "
            echo "Options ${htaccess}" >.htaccess
            cat ${httpd_conf} | perl -0777 -pe 's/# SSI-test-begin.*//gs' >${tmp_httpd_conf}
#            if [ "$(grep -q 'SSI-test-begin' ${httpd_conf}; echo $?)" == "0" ]; then
#                let lines=$(wc -l ${httpd_conf} | cut -d ' ' -f 1)-6
#                head -${lines} ${httpd_conf} >${tmp_httpd_conf}
#            else
#                cp -f ${httpd_conf} ${tmp_httpd_conf}
#            fi
            echo "# SSI-test-begin (written $(date))" >>${tmp_httpd_conf}
            echo "<Directory \"/var/www/html/test\">" >>${tmp_httpd_conf}
            echo "Options ${options}" >>${tmp_httpd_conf} 
            echo "AllowOverride ${allowoverride}" >>${tmp_httpd_conf}
            echo "</Directory>" >>${tmp_httpd_conf}
            echo "# SSI-test-end" >>${tmp_httpd_conf}
            cp -f ${tmp_httpd_conf} ${httpd_conf}
	    killall httpd >/dev/null 2>&1
            sleep 3
            /usr/sbin/httpd >/dev/null 2>&1
            sleep 3
            if [ "$?" != "0" ]; then
                printf " httpd failed to restart! ABORTING!\n\n"
                exit 1
            fi
            out=$(lynx -cache=0 -dump http://localhost/test/index.shtml)
            bad=""
            if [ "$(echo ${out} | grep -i -q 'Internal Server Error'; echo $?)" == "0" ]; then
                printf "result: noexec (internal server error)\n"
            elif [ "$(echo ${out} | grep -i -q '/var/www/html'; echo $?)" == "1" ]; then
                printf "result: noexec (fail)\n"
            else
                if [ "${options}" == "None" ]; then
                    if [ "${allowoverride}" == "Options=IncludesNoExec" ]; then
                        if [ "${htaccess}" == "+Includes" ]; then
                            bad="[**BAD**]"
                        fi
                    fi
                fi
                if [ "${options}" == "IncludesNoExec" ]; then
                    if [ "${allowoverride}" == "Options=IncludesNoExec" ]; then
                        bad="[**BAD**]"
                    fi
                fi
                printf "result: exec ${bad} (options=${options}, allowoverride=${allowoverride}, htaccess=${htaccess})\n"
            fi
        done
    done
done

mv -f ${org_httpd_conf} ${httpd_conf}

